<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
    <title>Home - Library Admin</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <main layout:fragment="content">
        <div class="container mt-4">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 text-white-50">Total Books</h6>
                                <h2 class="mb-0 fw-bold" th:text="${totalBooks}">0</h2>
                            </div>
                            <i class="bi bi-book fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 text-white-50">Categories</h6>
                                <h2 class="mb-0 fw-bold" th:text="${totalCategories}">0</h2>
                            </div>
                            <i class="bi bi-tag fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 text-white-50">Available</h6>
                                <h2 class="mb-0 fw-bold" th:text="${totalAvailable}">0</h2>
                            </div>
                            <i class="bi bi-check-circle fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 text-white-50">Total Stock</h6>
                                <h2 class="mb-0 fw-bold" th:text="${totalStock}">0</h2>
                            </div>
                            <i class="bi bi-box-seam fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <h4 class="mb-0">
                                <i class="bi bi-collection me-2"></i>
                                Book Collection
                            </h4>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">
                                <i class="bi bi-plus-lg me-2"></i>
                                Add New Book
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <form th:action="@{/}" method="get">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" name="search" class="form-control" 
                                   placeholder="Search by title, author, ISBN, or category..."
                                   th:value="${search}">
                            <button class="btn btn-primary" type="submit">
                                Search
                            </button>
                            <a th:href="@{/}" class="btn btn-outline-secondary" th:if="${search != null && !search.isEmpty()}">
                                <i class="bi bi-x-lg"></i> Clear
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Books Table -->
            <div class="card">
                <div class="card-body">
                    <div th:if="${books.isEmpty()}" class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h4 class="mt-3 text-muted">No books found</h4>
                        <p class="text-muted" th:if="${search != null && !search.isEmpty()}">
                            Try adjusting your search or 
                            <a th:href="@{/}">clear the filter</a>
                        </p>
                        <button type="button" class="btn btn-primary mt-3" 
                                data-bs-toggle="modal" data-bs-target="#addBookModal"
                                th:if="${search == null || search.isEmpty()}">
                            <i class="bi bi-plus-lg me-2"></i>
                            Add Your First Book
                        </button>
                    </div>

                    <div th:if="${!books.isEmpty()}" class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th width="100">Cover</th>
                                    <th>Title</th>
                                    <th>Author</th>
                                    <th>ISBN</th>
                                    <th>Category</th>
                                    <th class="text-center">Stock</th>
                                    <th class="text-center">Available</th>
                                    <th width="150" class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="book : ${books}">
                                    <td>
                                        <img th:if="${book.cover != null}" 
                                             th:src="@{'/books/cover/' + ${book.cover}}" 
                                             class="book-cover-thumbnail"
                                             alt="Book Cover">
                                        <div th:if="${book.cover == null}" 
                                             class="book-cover-thumbnail bg-secondary d-flex align-items-center justify-content-center">
                                            <i class="bi bi-image text-white fs-3"></i>
                                        </div>
                                    </td>
                                    <td>
                                        <a th:href="@{'/books/' + ${book.id}}" 
                                           class="text-decoration-none fw-semibold text-primary"
                                           th:text="${book.title}">Title</a>
                                    </td>
                                    <td th:text="${book.author}">Author</td>
                                    <td>
                                        <code th:text="${book.isbn}">ISBN</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-info" th:text="${book.category}">Category</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-primary" th:text="${book.stock}">0</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge"
                                              th:classappend="${book.availableStock > 0 ? 'bg-success' : 'bg-danger'}"
                                              th:text="${book.availableStock}">0</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <!-- View Button -->
                                            <a th:href="@{'/books/' + ${book.id}}" 
                                               class="btn btn-outline-primary"
                                               title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <!-- Edit Button -->
                                            <button type="button" 
                                                    class="btn btn-outline-warning"
                                                    th:attr="data-id=${book.id},
                                                             data-title=${book.title},
                                                             data-author=${book.author},
                                                             data-isbn=${book.isbn},
                                                             data-category=${book.category},
                                                             data-publisher=${book.publisher},
                                                             data-year=${book.publicationYear},
                                                             data-stock=${book.stock}"
                                                    onclick="openEditModal(this)"
                                                    title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <!-- Delete Button -->
                                            <button type="button" 
                                                    class="btn btn-outline-danger"
                                                    th:attr="data-id=${book.id},
                                                             data-title=${book.title}"
                                                    onclick="openDeleteModal(this)"
                                                    title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="row mt-4" th:if="${!books.isEmpty()}">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="bi bi-pie-chart me-2"></i>
                                Books by Category
                            </h5>
                            <canvas id="categoryChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="bi bi-bar-chart me-2"></i>
                                Stock Overview (Top 10)
                            </h5>
                            <canvas id="stockChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Include Modals -->
        <div th:replace="~{models/books/add :: addBookModal}"></div>
        <div th:replace="~{models/books/edit :: editBookModal}"></div>
        <div th:replace="~{models/books/delete :: deleteBookModal}"></div>
    </main>

    <th:block layout:fragment="scripts">
        <script>
            /*<![CDATA[*/
            // ============================================================================
            // DATA FROM SERVER
            // ============================================================================
            const booksData = /*[[${books}]]*/ [];
            const editBookModalOpen = /*[[${editBookModalOpen}]]*/ false;
            const editBookModalId = /*[[${editBookModalId}]]*/ null;
            const deleteBookModalOpen = /*[[${deleteBookModalOpen}]]*/ false;
            const deleteBookModalId = /*[[${deleteBookModalId}]]*/ null;
            
            console.log('üìö Books Data:', booksData);
            console.log('‚úèÔ∏è Edit Modal:', editBookModalOpen, editBookModalId);
            console.log('üóëÔ∏è Delete Modal:', deleteBookModalOpen, deleteBookModalId);
            
            // ============================================================================
            // MAIN INITIALIZATION
            // ============================================================================
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize charts
                if (booksData && booksData.length > 0) {
                    console.log('üìä Initializing charts...');
                    initializeCharts();
                }

                // Show toast messages
                handleToastMessages();

                // Handle auto-open modals from detail page
                handleAutoOpenModals();
            });

            // ============================================================================
            // TOAST MESSAGES
            // ============================================================================
            function handleToastMessages() {
                const successMsg = /*[[${success}]]*/ null;
                const errorMsg = /*[[${error}]]*/ null;
                
                if (successMsg) {
                    showToast('success', successMsg);
                }
                if (errorMsg) {
                    showToast('error', errorMsg);
                }
            }

            // ============================================================================
            // AUTO-OPEN MODALS (dari detail page via query parameters)
            // ============================================================================
            function handleAutoOpenModals() {
                // Auto-open Edit modal
                if (editBookModalOpen && editBookModalId) {
                    console.log('üîì Auto-opening edit modal for book ID:', editBookModalId);
                    const book = booksData.find(b => b.id == editBookModalId);
                    if (book) {
                        const fakeButton = createFakeButtonForEdit(book);
                        openEditModal(fakeButton);
                    }
                }

                // Auto-open Delete modal
                if (deleteBookModalOpen && deleteBookModalId) {
                    console.log('üîì Auto-opening delete modal for book ID:', deleteBookModalId);
                    const book = booksData.find(b => b.id == deleteBookModalId);
                    if (book) {
                        const fakeButton = createFakeButtonForDelete(book);
                        openDeleteModal(fakeButton);
                    }
                }
            }

            function createFakeButtonForEdit(book) {
                const btn = document.createElement('button');
                btn.setAttribute('data-id', book.id);
                btn.setAttribute('data-title', book.title);
                btn.setAttribute('data-author', book.author);
                btn.setAttribute('data-isbn', book.isbn);
                btn.setAttribute('data-category', book.category);
                btn.setAttribute('data-publisher', book.publisher || '');
                btn.setAttribute('data-year', book.publicationYear || '');
                btn.setAttribute('data-stock', book.stock);
                return btn;
            }

            function createFakeButtonForDelete(book) {
                const btn = document.createElement('button');
                btn.setAttribute('data-id', book.id);
                btn.setAttribute('data-title', book.title);
                return btn;
            }

           // ============================================================================
// OPEN EDIT MODAL (UPDATED)
// ============================================================================
function openEditModal(button) {
    console.log("‚úèÔ∏è Opening edit modal");
    
    try {
        const bookId = button.getAttribute('data-id');
        const title = button.getAttribute('data-title') || '';
        const author = button.getAttribute('data-author') || '';
        const isbn = button.getAttribute('data-isbn') || ''; // Pastikan ISBN diambil
        const category = button.getAttribute('data-category') || '';
        const publisher = button.getAttribute('data-publisher') || '';
        const year = button.getAttribute('data-year') || '';
        const stock = button.getAttribute('data-stock') || '';
        
        // Populate form fields
        document.getElementById('editBookId').value = bookId; // ID Masuk ke Hidden Input
        document.getElementById('editTitle').value = title;
        document.getElementById('editAuthor').value = author;
        // Pastikan Anda punya input ID 'editIsbn' di HTML edit.html, jika tidak hapus baris ini
        // document.getElementById('editIsbn').value = isbn; 
        document.getElementById('editCategory').value = category;
        document.getElementById('editPublisher').value = publisher;
        document.getElementById('editPublicationYear').value = year;
        document.getElementById('editStock').value = stock;
        
        // HAPUS BAGIAN "form.action = ..." YANG LAMA
        // Kita gunakan action default yang ada di HTML edit.html (/books/update)
        
        // Show modal
        const modalEl = document.getElementById('editBookModal');
        if (modalEl) {
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        }
    } catch (error) {
        console.error('‚ùå Error opening edit modal:', error);
    }
}

            // ============================================================================
            // TOAST NOTIFICATION
            // ============================================================================
            function showToast(type, message) {
                let toastContainer = document.querySelector('.toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                    toastContainer.style.zIndex = '9999';
                    document.body.appendChild(toastContainer);
                }

                const toastId = 'toast-' + Date.now();
                const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
                const icon = type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill';
                
                const toastHTML = `
                    <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                <i class="bi bi-${icon} me-2"></i>
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
                toast.show();
                
                toastElement.addEventListener('hidden.bs.toast', function() {
                    toastElement.remove();
                });
            }

            // ============================================================================
            // INITIALIZE CHARTS
            // ============================================================================
            function initializeCharts() {
                try {
                    if (typeof Chart === 'undefined') {
                        console.error('‚ùå Chart.js not loaded!');
                        return;
                    }

                    // Category Chart
                    initializeCategoryChart();
                    
                    // Stock Chart
                    initializeStockChart();
                    
                } catch (error) {
                    console.error('‚ùå Error initializing charts:', error);
                }
            }

            function initializeCategoryChart() {
                const categoryData = {};
                booksData.forEach(book => {
                    const category = book.category || 'Uncategorized';
                    categoryData[category] = (categoryData[category] || 0) + 1;
                });

                const canvas = document.getElementById('categoryChart');
                if (canvas) {
                    new Chart(canvas.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(categoryData),
                            datasets: [{
                                data: Object.values(categoryData),
                                backgroundColor: [
                                    '#4f46e5', '#f59e0b', '#10b981', '#ef4444', 
                                    '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { 
                                    position: 'bottom',
                                    labels: { padding: 15, font: { size: 12 } }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => ctx.label + ': ' + ctx.parsed + ' books'
                                    }
                                }
                            }
                        }
                    });
                    console.log('‚úÖ Category chart initialized');
                }
            }

            function initializeStockChart() {
                const sortedBooks = [...booksData].sort((a, b) => b.stock - a.stock).slice(0, 10);
                const labels = sortedBooks.map(b => {
                    const title = b.title || 'Untitled';
                    return title.length > 20 ? title.substring(0, 20) + '...' : title;
                });
                const stockData = sortedBooks.map(b => b.stock || 0);
                const availableData = sortedBooks.map(b => b.availableStock || 0);

                const canvas = document.getElementById('stockChart');
                if (canvas) {
                    new Chart(canvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Total Stock',
                                    data: stockData,
                                    backgroundColor: '#4f46e5',
                                    borderRadius: 5
                                },
                                {
                                    label: 'Available',
                                    data: availableData,
                                    backgroundColor: '#10b981',
                                    borderRadius: 5
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                y: { beginAtZero: true, ticks: { stepSize: 1 } },
                                x: { ticks: { maxRotation: 45, minRotation: 45 } }
                            },
                            plugins: {
                                legend: { 
                                    position: 'bottom',
                                    labels: { padding: 15, font: { size: 12 } }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y + ' books'
                                    }
                                }
                            }
                        }
                    });
                    console.log('‚úÖ Stock chart initialized');
                }
            }
            /*]]>*/
        </script>
    </th:block>
</body>
</html>