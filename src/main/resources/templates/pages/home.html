<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
    <title>Home - Library Admin</title>
</head>
<body>
    <main layout:fragment="content">
        <div class="container mt-4">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 text-white-50">Total Books</h6>
                                <h2 class="mb-0 fw-bold" th:text="${totalBooks}">0</h2>
                            </div>
                            <i class="bi bi-book fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 text-white-50">Categories</h6>
                                <h2 class="mb-0 fw-bold" th:text="${totalCategories}">0</h2>
                            </div>
                            <i class="bi bi-tag fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 text-white-50">Available</h6>
                                <h2 class="mb-0 fw-bold" th:text="${totalAvailable}">0</h2>
                            </div>
                            <i class="bi bi-check-circle fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 text-white-50">Total Stock</h6>
                                <h2 class="mb-0 fw-bold" th:text="${totalStock}">0</h2>
                            </div>
                            <i class="bi bi-box-seam fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <h4 class="mb-0">
                                <i class="bi bi-collection me-2"></i>
                                Book Collection
                            </h4>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">
                                <i class="bi bi-plus-lg me-2"></i>
                                Add New Book
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <form th:action="@{/}" method="get">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" name="search" class="form-control" 
                                   placeholder="Search by title, author, ISBN, or category..."
                                   th:value="${search}">
                            <button class="btn btn-primary" type="submit">
                                Search
                            </button>
                            <a th:href="@{/}" class="btn btn-outline-secondary" th:if="${search != null && !search.isEmpty()}">
                                <i class="bi bi-x-lg"></i> Clear
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Books Table -->
            <div class="card">
                <div class="card-body">
                    <div th:if="${books.isEmpty()}" class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h4 class="mt-3 text-muted">No books found</h4>
                        <p class="text-muted" th:if="${search != null && !search.isEmpty()}">
                            Try adjusting your search or 
                            <a th:href="@{/}">clear the filter</a>
                        </p>
                        <button type="button" class="btn btn-primary mt-3" 
                                data-bs-toggle="modal" data-bs-target="#addBookModal"
                                th:if="${search == null || search.isEmpty()}">
                            <i class="bi bi-plus-lg me-2"></i>
                            Add Your First Book
                        </button>
                    </div>

                    <div th:if="${!books.isEmpty()}" class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th width="100">Cover</th>
                                    <th>Title</th>
                                    <th>Author</th>
                                    <th>ISBN</th>
                                    <th>Category</th>
                                    <th class="text-center">Stock</th>
                                    <th class="text-center">Available</th>
                                    <th width="150" class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="book : ${books}">
                                    <td>
                                        <img th:if="${book.cover != null}" 
                                             th:src="@{'/books/cover/' + ${book.cover}}" 
                                             class="book-cover-thumbnail"
                                             alt="Book Cover">
                                        <div th:if="${book.cover == null}" 
                                             class="book-cover-thumbnail bg-secondary d-flex align-items-center justify-content-center">
                                            <i class="bi bi-image text-white fs-3"></i>
                                        </div>
                                    </td>
                                    <td>
                                        <a th:href="@{'/books/' + ${book.id}}" 
                                           class="text-decoration-none fw-semibold text-primary"
                                           th:text="${book.title}">Title</a>
                                    </td>
                                    <td th:text="${book.author}">Author</td>
                                    <td>
                                        <code th:text="${book.isbn}">ISBN</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-info" th:text="${book.category}">Category</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-primary" th:text="${book.stock}">0</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge"
                                              th:classappend="${book.availableStock > 0 ? 'bg-success' : 'bg-danger'}"
                                              th:text="${book.availableStock}">0</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <a th:href="@{'/books/' + ${book.id}}" 
                                               class="btn btn-outline-primary"
                                               title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <!-- PERBAIKAN: Tombol Edit diperbaiki -->
                                            <button type="button" 
                                                    class="btn btn-outline-warning"
                                                    th:data-id="${book.id}"
                                                    onclick="openEditModal(this.getAttribute('data-id'))"
                                                    title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" 
                                                    class="btn btn-outline-danger"
                                                    th:data-id="${book.id}"
                                                    th:data-title="${book.title}"
                                                    onclick="openDeleteModal(this.getAttribute('data-id'), this.getAttribute('data-title'))"
                                                    title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="row mt-4" th:if="${!books.isEmpty()}">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="bi bi-pie-chart me-2"></i>
                                Books by Category
                            </h5>
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="bi bi-bar-chart me-2"></i>
                                Stock Overview (Top 10)
                            </h5>
                            <canvas id="stockChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals (Menggunakan path 'models' sesuai struktur folder Anda) -->
        <div th:replace="~{models/books/add :: addBookModal}"></div>
        <div th:replace="~{models/books/edit :: editBookModal}"></div>
        <div th:replace="~{models/books/delete :: deleteBookModal}"></div>
    </main>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            /*<![CDATA[*/
            const books = /*[[${books}]]*/ [];
            
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize charts if books exist
                if (books && books.length > 0) {
                    initializeCharts();
                }

                // Setup delete confirmation validation
                setupDeleteConfirmation();

                // Show success/error toast messages
                const successMsg = /*[[${success}]]*/ null;
                const errorMsg = /*[[${error}]]*/ null;
                
                if (successMsg) {
                    showToast('success', successMsg);
                }
                if (errorMsg) {
                    // Logic ini untuk memastikan toast error muncul jika bukan error dari modal form
                    // Tapi jika error dari form modal (seperti validasi), modal biasanya dirender ulang oleh controller
                    showToast('error', errorMsg);
                    
                    // Jika ada error dari server saat submit add/edit, 
                    // controller Anda harus mengirim flag 'addBookModalOpen' dsb.
                    if (/*[[${addBookModalOpen}]]*/ false) {
                        new bootstrap.Modal(document.getElementById('addBookModal')).show();
                    }
                    if (/*[[${editBookModalOpen}]]*/ false) {
                         // Perlu logic khusus jika ingin membuka modal edit otomatis saat error server
                        const bookId = /*[[${editBookModalId}]]*/ null;
                        if(bookId) openEditModal(bookId); 
                    }
                }
            });

            function setupDeleteConfirmation() {
                const confirmInput = document.getElementById('deleteConfirmTitle');
                const deleteBtn = document.getElementById('confirmDeleteBtn');
                const titleDisplay = document.getElementById('deleteBookTitleDisplay');
                
                if (confirmInput && deleteBtn && titleDisplay) {
                    confirmInput.addEventListener('input', function() {
                        const inputValue = this.value.trim();
                        const expectedTitle = titleDisplay.textContent.trim();
                        deleteBtn.disabled = inputValue !== expectedTitle;
                    });
                }
            }

            // PERBAIKAN: Fungsi Edit yang lebih aman
            function openEditModal(bookId) {
                console.log("Opening edit modal for ID:", bookId);
                
                if (!books || books.length === 0) {
                    console.error("No books data found");
                    return;
                }

                // Gunakan toString() untuk perbandingan yang aman (angka vs string)
                const book = books.find(b => b.id.toString() === bookId.toString());
                
                if (!book) {
                    console.error("Book not found for ID:", bookId);
                    return;
                }

                // Populate form fields
                document.getElementById('editBookId').value = book.id;
                document.getElementById('editTitle').value = book.title;
                document.getElementById('editAuthor').value = book.author;
                document.getElementById('editIsbn').value = book.isbn;
                document.getElementById('editCategory').value = book.category;
                document.getElementById('editPublisher').value = book.publisher || '';
                document.getElementById('editPublicationYear').value = book.publicationYear || '';
                document.getElementById('editStock').value = book.stock;
                
                // Update form action URL
                const form = document.getElementById('editBookForm');
                if (form) {
                    form.action = '/books/edit/' + book.id;
                }

                // Show modal menggunakan getOrCreateInstance
                const modalEl = document.getElementById('editBookModal');
                if (modalEl) {
                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    modal.show();
                }
            }

            function openDeleteModal(bookId, bookTitle) {
                // Set values
                document.getElementById('deleteBookId').value = bookId;
                document.getElementById('deleteBookTitleDisplay').textContent = bookTitle;
                const confirmInput = document.getElementById('deleteConfirmTitle');
                confirmInput.placeholder = 'Type: ' + bookTitle;
                confirmInput.value = '';
                
                // Update form action URL
                const form = document.getElementById('deleteBookForm');
                if (form) {
                    form.action = '/books/delete/' + bookId;
                }
                
                // Reset and disable delete button
                const deleteBtn = document.getElementById('confirmDeleteBtn');
                if (deleteBtn) {
                    deleteBtn.disabled = true;
                }
                
                // Show modal
                const modalEl = document.getElementById('deleteBookModal');
                if (modalEl) {
                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    modal.show();
                }
            }

            function showToast(type, message) {
                // Create toast container if not exists
                let toastContainer = document.querySelector('.toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                    toastContainer.style.zIndex = '9999';
                    document.body.appendChild(toastContainer);
                }

                // Create toast
                const toastId = 'toast-' + Date.now();
                const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
                const icon = type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill';
                
                const toastHTML = `
                    <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                <i class="bi bi-${icon} me-2"></i>
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
                toast.show();
                
                // Remove toast after hidden
                toastElement.addEventListener('hidden.bs.toast', function() {
                    toastElement.remove();
                });
            }

            function initializeCharts() {
                // Category Distribution Chart
                const categoryData = {};
                books.forEach(book => {
                    categoryData[book.category] = (categoryData[book.category] || 0) + 1;
                });

                const categoryChart = document.getElementById('categoryChart');
                if (categoryChart) {
                    new Chart(categoryChart, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(categoryData),
                            datasets: [{
                                data: Object.values(categoryData),
                                backgroundColor: [
                                    '#4f46e5', '#f59e0b', '#10b981', '#ef4444', 
                                    '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }

                // Top 10 Stock Chart
                const sortedBooks = [...books].sort((a, b) => b.stock - a.stock).slice(0, 10);
                const stockLabels = sortedBooks.map(b => b.title.length > 20 ? b.title.substring(0, 20) + '...' : b.title);
                const stockData = sortedBooks.map(b => b.stock);
                const availableData = sortedBooks.map(b => b.availableStock);

                const stockChart = document.getElementById('stockChart');
                if (stockChart) {
                    new Chart(stockChart, {
                        type: 'bar',
                        data: {
                            labels: stockLabels,
                            datasets: [
                                {
                                    label: 'Total Stock',
                                    data: stockData,
                                    backgroundColor: '#4f46e5'
                                },
                                {
                                    label: 'Available',
                                    data: availableData,
                                    backgroundColor: '#10b981'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            },
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }
            }
            /*]]>*/
        </script>
    </th:block>
</body>
</html>